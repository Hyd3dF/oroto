<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Institutional Forex AI - Terminal</title>
    <link rel="stylesheet" href="style.css">
</head>

<body>

    <nav class="navbar">
        <div class="container nav-content">
            <div class="brand">OROYA AI</div>
            <a href="index.html" class="link">Exit Terminal</a>
        </div>
    </nav>

    <div class="container" style="max-width: 600px; padding-top: 4rem;">

        <div class="center-text mb-2">
            <h1>Upload Chart</h1>
            <p>Institutional AI Analysis for Gold (XAUUSD)</p>
        </div>

        <form id="analysis-form" onsubmit="return false;">

            <!-- File Input -->
            <div class="upload-zone" id="drop-zone">
                <div class="upload-icon">â†‘</div>
                <div class="upload-text">Select Chart Image (M5 / Gold)</div>
                <input type="file" id="file-input" accept="image/*" style="display: none;">
            </div>

            <div id="preview-container" class="preview-container">
                <img id="preview-img" src="">
            </div>

            <!-- Fixed Options (Visual Only) -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1.5rem;">
                <div class="form-group" style="margin-bottom: 0;">
                    <label class="label">Asset Class (Fixed)</label>
                    <input type="text" class="input" value="Gold (XAUUSD)" disabled
                        style="cursor: not-allowed; opacity: 0.7;">
                </div>
                <div class="form-group" style="margin-bottom: 0;">
                    <label class="label">Timeframe (Fixed)</label>
                    <input type="text" class="input" value="M5 (Scalping)" disabled
                        style="cursor: not-allowed; opacity: 0.7;">
                </div>
            </div>

            <!-- Session Selection -->
            <div class="form-group">
                <label class="label">Market Session</label>
                <div class="select-wrapper">
                    <select id="session-select" class="select">
                        <option value="New York">New York (EST)</option>
                        <option value="London">London (UTC)</option>
                        <option value="Tokyo">Tokyo (JST)</option>
                    </select>
                </div>
            </div>

            <!-- Context removed as per request -->

            <button type="button" id="submit-btn" class="btn" style="width: 100%; margin-top: 1rem;" disabled>
                <div id="btn-loader" class="spinner"></div>
                <span id="btn-text">Start Analysis</span>
            </button>

        </form>

        <div id="result-area" class="terminal-output">
            <div style="color: var(--text-dim); margin-bottom: 1rem; font-size: 0.8rem;">/// SYSTEM OUTPUT</div>
            <div id="result-content"></div>
        </div>

    </div>

    <script>
        const dropZone = document.getElementById('drop-zone');
        const fileInput = document.getElementById('file-input');
        const previewContainer = document.getElementById('preview-container');
        const previewImg = document.getElementById('preview-img');
        const submitBtn = document.getElementById('submit-btn');
        const resultArea = document.getElementById('result-area');
        const resultContent = document.getElementById('result-content');
        const btnText = document.getElementById('btn-text');
        const btnLoader = document.getElementById('btn-loader');

        // File Selection Logic
        dropZone.addEventListener('click', () => {
            fileInput.click();
        });

        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function (event) {
                    previewImg.src = event.target.result;
                    previewContainer.style.display = 'block';
                    dropZone.style.display = 'none';
                    submitBtn.disabled = false;
                    btnText.textContent = "Run Analysis";
                }
                reader.readAsDataURL(file);
            }
        });

        // Analysis Logic
        let isProcessing = false;

        submitBtn.addEventListener('click', () => {
            if (isProcessing) return;
            const file = fileInput.files[0];
            if (!file) return;
            runAnalysis();
        });

        async function runAnalysis() {
            if (isProcessing) return;

            const file = fileInput.files[0];
            isProcessing = true;

            // UI Loading State
            btnText.textContent = "Analyzing...";
            btnLoader.style.display = "inline-block";
            submitBtn.disabled = true;
            resultArea.style.display = 'none';
            resultContent.innerHTML = '';

            // Fixed Data
            const asset = "XAUUSD";
            const timeframe = "M5";

            // User Selected Data
            const session = document.getElementById('session-select').value;
            const timezone = session;
            const exchange = session;

            const formData = new FormData();
            formData.append('file', file);
            formData.append('asset', asset);
            formData.append('timeframe', timeframe);
            formData.append('timezone', timezone);
            formData.append('exchange', exchange);

            console.log("Sending Analysis Request:", { asset, timeframe, session });

            try {
                // Production Webhook URL
                const response = await fetch('http://n8n-kkskgk8wss4scs8kkogcs4cg.91.99.182.76.sslip.io/webhook/4854c27c-9696-478b-b9ec-abbce0de50ca', {
                    method: 'POST',
                    body: formData,
                    cache: 'no-cache'
                });

                if (response.ok) {
                    const text = await response.text();
                    let output = text;
                    try {
                        const json = JSON.parse(text);
                        output = json.output || json.message || json.result || json.text || JSON.stringify(json, null, 2);
                    } catch (e) { }

                    // Show Result
                    resultContent.innerHTML = output.replace(/\n/g, '<br>');
                    resultArea.style.display = 'block';
                    resultArea.scrollIntoView({ behavior: 'smooth' });

                    // Reset
                    btnText.textContent = "Analysis Complete";
                    btnLoader.style.display = "none";
                    submitBtn.disabled = false;

                    setTimeout(() => {
                        btnText.textContent = "Run New Analysis";
                        isProcessing = false;
                    }, 1000);

                } else {
                    throw new Error('Server returned ' + response.status);
                }
            } catch (err) {
                console.error("Fetch error:", err);
                resultContent.textContent = "Error: " + err.message;
                resultArea.style.display = 'block';
                btnLoader.style.display = "none";
                btnText.textContent = "Retry";
                submitBtn.disabled = false;
                isProcessing = false;
            }
        }
    </script>
</body>

</html>